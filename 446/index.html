<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>手を動かしながらロックを学ぶ 2</title>
    <meta property="og:title" content="手を動かしながらロックを学ぶ 2">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://blog.naoty.dev/446/">
    <meta property="og:image" content="https://blog.naoty.dev/icon-512.png">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:creator" content="@naoty_k">
    <meta name="theme-color" content="#fff">
    <link href="/feed.xml" rel="alternate" type="application/atom+xml">
    <link href="/normalize.css" rel="stylesheet">
    <link href="/main.css" rel="stylesheet">
    <link href="/highlight.css" rel="stylesheet">
    <link href="/favicon.png" rel="shortcut icon" type="image/png">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192.png">
  </head>
  <body>
    <main>
      <article>
        <header>
          <h1 class="title mt-0">手を動かしながらロックを学ぶ 2</h1>
          <p class="metadata">
            <time datetime="2021-06-09T22:19:00.000+0000">2021-06-09 22:19</time>
            <a href="/mysql/">#mysql</a>
          </p>
        </header>
        <section class="body">
          <ul>
<li>
<a href="/445/">Part 1</a>: <code>select</code>による特定の一行に対するロック</li>
<li>Part 2: <code>select</code>による複数行に対するロック</li>
<li>
<a href="/447/">Part 3</a>: <code>insert</code>, <code>update</code>, <code>delete</code>によるロック</li>
</ul>
<p>前回に続いて、今度は<code>select ... for update</code>で複数件取得した場合のロックについて試してみる。</p>
<p>前回同様にworldデータベースの<code>city</code>テーブルを使う。</p>
<pre lang="sql" class="highlight highlight-sql"><span class="n">MySQL</span> <span class="p">(</span><span class="k">none</span><span class="p">)</span><span class="o">@</span><span class="p">(</span><span class="k">none</span><span class="p">):</span><span class="n">world</span><span class="o">&gt;</span> <span class="k">show</span> <span class="k">create</span> <span class="k">table</span> <span class="n">city</span> <span class="err">\</span><span class="k">G</span>
<span class="o">***************************</span><span class="p">[</span> <span class="mi">1</span><span class="p">.</span> <span class="k">row</span> <span class="p">]</span><span class="o">***************************</span>
<span class="k">Table</span>        <span class="o">|</span> <span class="n">city</span>
<span class="k">Create</span> <span class="k">Table</span> <span class="o">|</span> <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">`city`</span> <span class="p">(</span>
  <span class="nv">`ID`</span> <span class="nb">int</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
  <span class="nv">`Name`</span> <span class="nb">char</span><span class="p">(</span><span class="mi">35</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="s1">''</span><span class="p">,</span>
  <span class="nv">`CountryCode`</span> <span class="nb">char</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="s1">''</span><span class="p">,</span>
  <span class="nv">`District`</span> <span class="nb">char</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="s1">''</span><span class="p">,</span>
  <span class="nv">`Population`</span> <span class="nb">int</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="s1">'0'</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="nv">`ID`</span><span class="p">),</span>
  <span class="k">KEY</span> <span class="nv">`CountryCode`</span> <span class="p">(</span><span class="nv">`CountryCode`</span><span class="p">),</span>
  <span class="k">CONSTRAINT</span> <span class="nv">`city_ibfk_1`</span> <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="nv">`CountryCode`</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="nv">`country`</span> <span class="p">(</span><span class="nv">`Code`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="n">AUTO_INCREMENT</span><span class="o">=</span><span class="mi">4080</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8mb4</span> <span class="k">COLLATE</span><span class="o">=</span><span class="n">utf8mb4_0900_ai_ci</span>

<span class="mi">1</span> <span class="k">row</span> <span class="k">in</span> <span class="k">set</span>
<span class="nb">Time</span><span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">017</span><span class="n">s</span>
</pre>
<h1>下準備</h1>
<p>ロック待ちの確認にかかる時間を減らすため、timeoutを1秒にしておく。</p>
<pre lang="sql" class="highlight highlight-sql"><span class="n">MySQL</span> <span class="p">(</span><span class="k">none</span><span class="p">)</span><span class="o">@</span><span class="p">(</span><span class="k">none</span><span class="p">):</span><span class="n">world</span><span class="o">&gt;</span> <span class="k">set</span> <span class="n">innodb_lock_wait_timeout</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="k">rows</span> <span class="n">affected</span>
<span class="nb">Time</span><span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">001</span><span class="n">s</span>
</pre>
<p>あとで<code>show engine innodb status</code>でトランザクションの状態を確認するため、出力するようにする。</p>
<pre lang="sql" class="highlight highlight-sql"><span class="n">MySQL</span> <span class="p">(</span><span class="k">none</span><span class="p">)</span><span class="o">@</span><span class="p">(</span><span class="k">none</span><span class="p">):</span><span class="n">world</span><span class="o">&gt;</span> <span class="k">set</span> <span class="k">global</span> <span class="n">innodb_status_output_locks</span> <span class="o">=</span> <span class="k">on</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="k">rows</span> <span class="n">affected</span>
<span class="nb">Time</span><span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">002</span><span class="n">s</span>
</pre>
<h1>クラスタインデックスによるロック</h1>
<p>プライマリーキーを条件に指定して<code>select ... for update</code>してみる。</p>
<pre lang="sql" class="highlight highlight-sql"><span class="n">MySQL</span> <span class="p">(</span><span class="k">none</span><span class="p">)</span><span class="o">@</span><span class="p">(</span><span class="k">none</span><span class="p">):</span><span class="n">world</span><span class="o">&gt;</span> <span class="k">begin</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="k">rows</span> <span class="n">affected</span>
<span class="nb">Time</span><span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">000</span><span class="n">s</span>
<span class="n">MySQL</span> <span class="p">(</span><span class="k">none</span><span class="p">)</span><span class="o">@</span><span class="p">(</span><span class="k">none</span><span class="p">):</span><span class="n">world</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">city</span> <span class="k">where</span> <span class="nv">`ID`</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">for</span> <span class="k">update</span>
<span class="o">+</span><span class="c1">----+-------+-------------+----------+------------+</span>
<span class="o">|</span> <span class="n">ID</span> <span class="o">|</span> <span class="n">Name</span>  <span class="o">|</span> <span class="n">CountryCode</span> <span class="o">|</span> <span class="n">District</span> <span class="o">|</span> <span class="n">Population</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">----+-------+-------------+----------+------------+</span>
<span class="o">|</span> <span class="mi">1</span>  <span class="o">|</span> <span class="n">Kabul</span> <span class="o">|</span> <span class="n">AFG</span>         <span class="o">|</span> <span class="n">Kabol</span>    <span class="o">|</span> <span class="mi">1780000</span>    <span class="o">|</span>
<span class="o">+</span><span class="c1">----+-------+-------------+----------+------------+</span>

<span class="mi">1</span> <span class="k">row</span> <span class="k">in</span> <span class="k">set</span>
<span class="nb">Time</span><span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">011</span><span class="n">s</span>
</pre>
<p>どのようなロックがかかっているか確認するため<code>show engine innodb status</code>を実行して<code>TRANSACTIONS</code>を見る。</p>
<pre><code>------------
TRANSACTIONS
------------
Trx id counter 2668
Purge done for trx's n:o &lt; 2667 undo n:o &lt; 0 state: running but idle
History list length 0
LIST OF TRANSACTIONS FOR EACH SESSION:
---TRANSACTION 421394077937904, not started
0 lock struct(s), heap size 1136, 0 row lock(s)
---TRANSACTION 421394077936192, not started
0 lock struct(s), heap size 1136, 0 row lock(s)
---TRANSACTION 421394077935336, not started
0 lock struct(s), heap size 1136, 0 row lock(s)
---TRANSACTION 2667, ACTIVE 4 sec
2 lock struct(s), heap size 1136, 1 row lock(s)
MySQL thread id 47, OS thread handle 139918963160832, query id 369 localhost root
TABLE LOCK table `world`.`city` trx id 2667 lock mode IX
RECORD LOCKS space id 2 page no 6 n bits 248 index PRIMARY of table `world`.`city` trx id 2667 lock_mode X locks rec but not gap
Record lock, heap no 2 PHYSICAL RECORD: n_fields 7; compact format; info bits 0
 0: len 4; hex 80000001; asc     ;;
 1: len 6; hex 00000000063a; asc      :;;
 2: len 7; hex 820000008a0110; asc        ;;
 3: len 30; hex 4b6162756c20202020202020202020202020202020202020202020202020; asc Kabul
       ; (total 35 bytes);
 4: len 3; hex 414647; asc AFG;;
 5: len 20; hex 4b61626f6c202020202020202020202020202020; asc Kabol               ;;
 6: len 4; hex 801b2920; asc   ) ;;
</code></pre>
<blockquote>
<p>RECORD LOCKS space id 2 page no 6 n bits 248 index PRIMARY of table <code>world</code>.<code>city</code> trx id 2667 lock_mode X locks rec but not gap</p>
</blockquote>
<p><code>RECORD LOCKS</code>から始まる行に着目すると、クラスタインデックスに対するレコードロックを取得していることがわかる。レコードロックはそのまま、そのレコード自身に対するロックを指している。</p>
<p>試しに取得したレコードを<code>update</code>してみる。</p>
<pre lang="sql" class="highlight highlight-sql"><span class="n">MySQL</span> <span class="p">(</span><span class="k">none</span><span class="p">)</span><span class="o">@</span><span class="p">(</span><span class="k">none</span><span class="p">):</span><span class="n">world</span><span class="o">&gt;</span> <span class="k">begin</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="k">rows</span> <span class="n">affected</span>
<span class="nb">Time</span><span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">001</span><span class="n">s</span>
<span class="n">MySQL</span> <span class="p">(</span><span class="k">none</span><span class="p">)</span><span class="o">@</span><span class="p">(</span><span class="k">none</span><span class="p">):</span><span class="n">world</span><span class="o">&gt;</span> <span class="k">update</span> <span class="n">city</span> <span class="k">set</span> <span class="nv">`Population`</span> <span class="o">=</span> <span class="nv">`Population`</span> <span class="o">+</span> <span class="mi">1000000</span> <span class="k">where</span> <span class="nv">`ID`</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">(</span><span class="mi">1205</span><span class="p">,</span> <span class="s1">'Lock wait timeout exceeded; try restarting transaction'</span><span class="p">)</span>
</pre>
<p>次に、条件にマッチするレコードがなかったときのロックの範囲を確認する。</p>
<pre lang="sql" class="highlight highlight-sql"><span class="n">MySQL</span> <span class="n">root</span><span class="o">@</span><span class="n">localhost</span><span class="p">:</span><span class="n">world</span><span class="o">&gt;</span> <span class="k">begin</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="k">rows</span> <span class="n">affected</span>
<span class="nb">Time</span><span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">003</span><span class="n">s</span>
<span class="n">MySQL</span> <span class="n">root</span><span class="o">@</span><span class="n">localhost</span><span class="p">:</span><span class="n">world</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">city</span> <span class="k">where</span> <span class="nv">`ID`</span> <span class="o">=</span> <span class="mi">10000</span> <span class="k">for</span> <span class="k">update</span>
<span class="o">+</span><span class="c1">----+------+-------------+----------+------------+</span>
<span class="o">|</span> <span class="n">ID</span> <span class="o">|</span> <span class="n">Name</span> <span class="o">|</span> <span class="n">CountryCode</span> <span class="o">|</span> <span class="n">District</span> <span class="o">|</span> <span class="n">Population</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">----+------+-------------+----------+------------+</span>
<span class="o">+</span><span class="c1">----+------+-------------+----------+------------+</span>
<span class="mi">0</span> <span class="k">rows</span> <span class="k">in</span> <span class="k">set</span>
<span class="nb">Time</span><span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">011</span><span class="n">s</span>
</pre>
<pre><code>------------
TRANSACTIONS
------------
Trx id counter 7005
Purge done for trx's n:o &lt; 7001 undo n:o &lt; 0 state: running but idle
History list length 0
LIST OF TRANSACTIONS FOR EACH SESSION:
---TRANSACTION 421497825593776, not started
0 lock struct(s), heap size 1128, 0 row lock(s)
---TRANSACTION 421497825592968, not started
0 lock struct(s), heap size 1128, 0 row lock(s)
---TRANSACTION 7004, ACTIVE 162 sec
2 lock struct(s), heap size 1128, 1 row lock(s)
MySQL thread id 91, OS thread handle 140022380754688, query id 647 172.21.0.1 root starting
show engine innodb status
TABLE LOCK table `world`.`city` trx id 7004 lock mode IX
RECORD LOCKS space id 2 page no 35 n bits 232 index PRIMARY of table `world`.`city` trx id 7004 lock_mode X
Record lock, heap no 1 PHYSICAL RECORD: n_fields 1; compact format; info bits 0
 0: len 8; hex 73757072656d756d; asc supremum;;
</code></pre>
<blockquote>
<p>RECORD LOCKS space id 2 page no 35 n bits 232 index PRIMARY of table <code>world</code>.<code>city</code> trx id 7004 lock_mode X</p>
</blockquote>
<p>今度はレコードロックではなくネクストキーロックを取得している。ネクストキーロックとは、そのレコード自身とそのレコードと一つ前のレコードの間のギャップに対するロックを指している。</p>
<p>この場合は<code>suprenum</code>と呼ばれる、上限値を表す内部的なレコードに対するネクストキーロックが取得されている。よって、<code>suprenum</code>とその前のレコード、すなわち<code>id</code>が最大のレコードとの間のギャップに対してロックが取得されたということになる。</p>
<p>この状態で別セッションから新たな<code>city</code>を<code>insert</code>してみる。</p>
<pre lang="sql" class="highlight highlight-sql"><span class="n">MySQL</span> <span class="n">root</span><span class="o">@</span><span class="n">localhost</span><span class="p">:</span><span class="n">world</span><span class="o">&gt;</span> <span class="k">begin</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="k">rows</span> <span class="n">affected</span>
<span class="nb">Time</span><span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">003</span><span class="n">s</span>
<span class="n">MySQL</span> <span class="n">root</span><span class="o">@</span><span class="n">localhost</span><span class="p">:</span><span class="n">world</span><span class="o">&gt;</span> <span class="k">insert</span> <span class="k">into</span> <span class="n">city</span> <span class="p">(</span><span class="nv">`Name`</span><span class="p">,</span> <span class="nv">`CountryCode`</span><span class="p">,</span> <span class="nv">`District`</span><span class="p">,</span> <span class="nv">`Population`</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">'dummy'</span><span class="p">,</span> <span class="s1">'DUM'</span><span class="p">,</span> <span class="s1">'dummy'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">(</span><span class="mi">1205</span><span class="p">,</span> <span class="s1">'Lock wait timeout exceeded; try restarting transaction'</span><span class="p">)</span>
</pre>
<p><code>id</code>が最大のレコードと<code>suprenum</code>との間のギャップロックが取得されているため、<code>insert</code>がロック解除待ちになってしまった。</p>
<p>条件をいろいろ変えてみると、インデックスのどの範囲に含まれるかによってロックの種類や範囲は変わることがわかった。指定した条件を含むレコードの区間のギャップロックが取得されると考えてよさそうだ。</p>
<h1>セカンダリインデックスによるロック</h1>
<p>セカンダリインデックス<code>CountryCode</code>を条件に指定して<code>select ... for update</code>してみる。</p>
<pre lang="sql" class="highlight highlight-sql"><span class="n">MySQL</span> <span class="p">(</span><span class="k">none</span><span class="p">)</span><span class="o">@</span><span class="p">(</span><span class="k">none</span><span class="p">):</span><span class="n">world</span><span class="o">&gt;</span> <span class="k">begin</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="k">rows</span> <span class="n">affected</span>
<span class="nb">Time</span><span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">001</span><span class="n">s</span>
<span class="n">MySQL</span> <span class="p">(</span><span class="k">none</span><span class="p">)</span><span class="o">@</span><span class="p">(</span><span class="k">none</span><span class="p">):</span><span class="n">world</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">city</span> <span class="k">where</span> <span class="nv">`CountryCode`</span> <span class="o">=</span> <span class="s1">'AFG'</span> <span class="k">for</span> <span class="k">update</span>
<span class="o">+</span><span class="c1">----+----------------+-------------+----------+------------+</span>
<span class="o">|</span> <span class="n">ID</span> <span class="o">|</span> <span class="n">Name</span>           <span class="o">|</span> <span class="n">CountryCode</span> <span class="o">|</span> <span class="n">District</span> <span class="o">|</span> <span class="n">Population</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">----+----------------+-------------+----------+------------+</span>
<span class="o">|</span> <span class="mi">1</span>  <span class="o">|</span> <span class="n">Kabul</span>          <span class="o">|</span> <span class="n">AFG</span>         <span class="o">|</span> <span class="n">Kabol</span>    <span class="o">|</span> <span class="mi">1780000</span>    <span class="o">|</span>
<span class="o">|</span> <span class="mi">2</span>  <span class="o">|</span> <span class="n">Qandahar</span>       <span class="o">|</span> <span class="n">AFG</span>         <span class="o">|</span> <span class="n">Qandahar</span> <span class="o">|</span> <span class="mi">237500</span>     <span class="o">|</span>
<span class="o">|</span> <span class="mi">3</span>  <span class="o">|</span> <span class="n">Herat</span>          <span class="o">|</span> <span class="n">AFG</span>         <span class="o">|</span> <span class="n">Herat</span>    <span class="o">|</span> <span class="mi">186800</span>     <span class="o">|</span>
<span class="o">|</span> <span class="mi">4</span>  <span class="o">|</span> <span class="n">Mazar</span><span class="o">-</span><span class="n">e</span><span class="o">-</span><span class="n">Sharif</span> <span class="o">|</span> <span class="n">AFG</span>         <span class="o">|</span> <span class="n">Balkh</span>    <span class="o">|</span> <span class="mi">127800</span>     <span class="o">|</span>
<span class="o">+</span><span class="c1">----+----------------+-------------+----------+------------+</span>

<span class="mi">4</span> <span class="k">rows</span> <span class="k">in</span> <span class="k">set</span>
<span class="nb">Time</span><span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">013</span><span class="n">s</span>
</pre>
<p>先程と同様にロックを確認する。</p>
<pre><code>------------
TRANSACTIONS
------------
--- (snip) ---
---TRANSACTION 2650, ACTIVE 3 sec
4 lock struct(s), heap size 1136, 9 row lock(s)
MySQL thread id 36, OS thread handle 139918963455744, query id 301 localhost root
TABLE LOCK table `world`.`city` trx id 2650 lock mode IX
RECORD LOCKS space id 2 page no 14 n bits 1272 index CountryCode of table `world`.`city` trx id 2650 lock_mode X
Record lock, heap no 3 PHYSICAL RECORD: n_fields 2; compact format; info bits 0
 0: len 3; hex 414647; asc AFG;;
 1: len 4; hex 80000001; asc     ;;

Record lock, heap no 4 PHYSICAL RECORD: n_fields 2; compact format; info bits 0
 0: len 3; hex 414647; asc AFG;;
 1: len 4; hex 80000002; asc     ;;

Record lock, heap no 5 PHYSICAL RECORD: n_fields 2; compact format; info bits 0
 0: len 3; hex 414647; asc AFG;;
 1: len 4; hex 80000003; asc     ;;

Record lock, heap no 6 PHYSICAL RECORD: n_fields 2; compact format; info bits 0
 0: len 3; hex 414647; asc AFG;;
 1: len 4; hex 80000004; asc     ;;

RECORD LOCKS space id 2 page no 6 n bits 248 index PRIMARY of table `world`.`city` trx id 2650 lock_mode X locks rec but not gap
Record lock, heap no 2 PHYSICAL RECORD: n_fields 7; compact format; info bits 0
 0: len 4; hex 80000001; asc     ;;
 1: len 6; hex 00000000063a; asc      :;;
 2: len 7; hex 820000008a0110; asc        ;;
 3: len 30; hex 4b6162756c20202020202020202020202020202020202020202020202020; asc Kabul    ; (total 35 bytes);
 4: len 3; hex 414647; asc AFG;;
 5: len 20; hex 4b61626f6c202020202020202020202020202020; asc Kabol               ;;
 6: len 4; hex 801b2920; asc   ) ;;

Record lock, heap no 3 PHYSICAL RECORD: n_fields 7; compact format; info bits 0
 0: len 4; hex 80000002; asc     ;;
 1: len 6; hex 00000000063a; asc      :;;
 2: len 7; hex 820000008a011d; asc        ;;
 3: len 30; hex 51616e646168617220202020202020202020202020202020202020202020; asc Qandahar    ; (total 35 bytes);
 4: len 3; hex 414647; asc AFG;;
 5: len 20; hex 51616e6461686172202020202020202020202020; asc Qandahar            ;;
 6: len 4; hex 80039fbc; asc     ;;

Record lock, heap no 4 PHYSICAL RECORD: n_fields 7; compact format; info bits 0
 0: len 4; hex 80000003; asc     ;;
 1: len 6; hex 00000000063a; asc      :;;
 2: len 7; hex 820000008a012a; asc       *;;
 3: len 30; hex 486572617420202020202020202020202020202020202020202020202020; asc Herat    ; (total 35 bytes);
 4: len 3; hex 414647; asc AFG;;
 5: len 20; hex 4865726174202020202020202020202020202020; asc Herat               ;;
 6: len 4; hex 8002d9b0; asc     ;;

Record lock, heap no 5 PHYSICAL RECORD: n_fields 7; compact format; info bits 0
 0: len 4; hex 80000004; asc     ;;
 1: len 6; hex 00000000063a; asc      :;;
 2: len 7; hex 820000008a0137; asc       7;;
 3: len 30; hex 4d617a61722d652d53686172696620202020202020202020202020202020; asc Mazar-e-Sharif    ; (total 35 bytes);
 4: len 3; hex 414647; asc AFG;;
 5: len 20; hex 42616c6b68202020202020202020202020202020; asc Balkh               ;;
 6: len 4; hex 8001f338; asc    8;;

RECORD LOCKS space id 2 page no 14 n bits 1272 index CountryCode of table `world`.`city` trx id 2650 lock_mode X locks gap before rec
Record lock, heap no 7 PHYSICAL RECORD: n_fields 2; compact format; info bits 0
 0: len 3; hex 41474f; asc AGO;;
 1: len 4; hex 80000038; asc    8;;
--- (snip) ---
</code></pre>
<p><code>RECORD LOCKS</code>から始まる行に注目すると、3種類のロックを取得していることがわかる。</p>
<blockquote>
<p>RECORD LOCKS space id 2 page no 14 n bits 1272 index CountryCode of table <code>world</code>.<code>city</code> trx id 2650 lock_mode X</p>
</blockquote>
<p>これは<code>CountryCode</code>インデックスレコードに対してネクストキーロックを取得していることを表している。</p>
<p>今回は<code>AFG</code>にマッチする<code>Kabol</code>, <code>Qandahar</code>, <code>Herat</code>, <code>Balkh</code>を含むレコードと、それらのレコードの前のギャップにロックを取得することになる。また、<code>Kabol</code>は最小の値のはずなので、無限に小さい論理的なレコードとの間のギャップがロックされることになる。</p>
<p>試しに別のトランザクションから<code>AFG</code>かつ<code>Kabol</code>より小さい値を<code>insert</code>してみる。</p>
<pre lang="sql" class="highlight highlight-sql"><span class="n">MySQL</span> <span class="p">(</span><span class="k">none</span><span class="p">)</span><span class="o">@</span><span class="p">(</span><span class="k">none</span><span class="p">):</span><span class="n">world</span><span class="o">&gt;</span> <span class="k">insert</span> <span class="k">into</span> <span class="n">city</span> <span class="p">(</span><span class="nv">`Name`</span><span class="p">,</span> <span class="nv">`CountryCode`</span><span class="p">,</span> <span class="nv">`District`</span><span class="p">,</span> <span class="nv">`Population`</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">'aaa'</span><span class="p">,</span> <span class="s1">'AFG'</span><span class="p">,</span> <span class="s1">'aaa'</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
<span class="p">(</span><span class="mi">1205</span><span class="p">,</span> <span class="s1">'Lock wait timeout exceeded; try restarting transaction'</span><span class="p">)</span>
</pre>
<blockquote>
<p>RECORD LOCKS space id 2 page no 6 n bits 248 index PRIMARY of table <code>world</code>.<code>city</code> trx id 2650 lock_mode X locks rec but not gap</p>
</blockquote>
<p>これはクラスタインデックスに対してレコードロックを取得していることを表している。</p>
<p>試しに別のトランザクションからクラスタインデックスに含まれる値を<code>update</code>してみる。</p>
<pre lang="sql" class="highlight highlight-sql"><span class="n">MySQL</span> <span class="p">(</span><span class="k">none</span><span class="p">)</span><span class="o">@</span><span class="p">(</span><span class="k">none</span><span class="p">):</span><span class="n">world</span><span class="o">&gt;</span> <span class="k">update</span> <span class="n">city</span> <span class="k">set</span> <span class="nv">`Population`</span> <span class="o">=</span> <span class="nv">`Population`</span> <span class="o">+</span> <span class="mi">1000000</span> <span class="k">where</span> <span class="nv">`ID`</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">(</span><span class="mi">1205</span><span class="p">,</span> <span class="s1">'Lock wait timeout exceeded; try restarting transaction'</span><span class="p">)</span>
</pre>
<blockquote>
<p>RECORD LOCKS space id 2 page no 14 n bits 1272 index CountryCode of table <code>world</code>.<code>city</code> trx id 2650 lock_mode X locks gap before rec</p>
</blockquote>
<p>これは<code>CountryCode</code>インデックスレコードに対するギャップロックを取得していることを表している。ギャップロックとは、あるレコードとその前のレコードの間のギャップに対するロックを指している。</p>
<p>この行の下の方に以下のように出力されており、<code>CountryCode</code>が<code>AGO</code>はちょうど<code>AFG</code>の次の値になっているため、<code>AFG</code>と<code>AGO</code>の間のギャップをロックしていることになる。</p>
<blockquote>
<p>0: len 3; hex 41474f; asc AGO;;</p>
</blockquote>
<p>試しに別のトランザクションでこの間に新たな<code>CountryCode</code>を<code>insert</code>してみる。<code>CountryCode</code>には外部キー制約があるため<code>country</code>にも<code>insert</code>してから<code>insert</code>する。</p>
<pre lang="sql" class="highlight highlight-sql"><span class="n">MySQL</span> <span class="p">(</span><span class="k">none</span><span class="p">)</span><span class="o">@</span><span class="p">(</span><span class="k">none</span><span class="p">):</span><span class="n">world</span><span class="o">&gt;</span> <span class="k">insert</span> <span class="k">into</span> <span class="n">country</span> <span class="p">(</span><span class="nv">`Code`</span><span class="p">,</span> <span class="nv">`Name`</span><span class="p">,</span> <span class="nv">`Region`</span><span class="p">,</span> <span class="nv">`LocalName`</span><span class="p">,</span> <span class="nv">`GovernmentForm`</span><span class="p">,</span> <span class="nv">`Code2`</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">'AFZ'</span><span class="p">,</span> <span class="s1">'dummy'</span><span class="p">,</span> <span class="s1">'dummy'</span><span class="p">,</span> <span class="s1">'dummy'</span><span class="p">,</span> <span class="s1">'dummy'</span><span class="p">,</span> <span class="s1">'AZ'</span><span class="p">)</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">1</span> <span class="k">row</span> <span class="n">affected</span>
<span class="nb">Time</span><span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">002</span><span class="n">s</span>
<span class="n">MySQL</span> <span class="p">(</span><span class="k">none</span><span class="p">)</span><span class="o">@</span><span class="p">(</span><span class="k">none</span><span class="p">):</span><span class="n">world</span><span class="o">&gt;</span> <span class="k">insert</span> <span class="k">into</span> <span class="n">city</span> <span class="p">(</span><span class="nv">`Name`</span><span class="p">,</span> <span class="nv">`CountryCode`</span><span class="p">,</span> <span class="nv">`District`</span><span class="p">,</span> <span class="nv">`Population`</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">'aaa'</span><span class="p">,</span> <span class="s1">'AFZ'</span><span class="p">,</span> <span class="s1">'aaa'</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
<span class="p">(</span><span class="mi">1205</span><span class="p">,</span> <span class="s1">'Lock wait timeout exceeded; try restarting transaction'</span><span class="p">)</span>
</pre>
<p>次に、条件にマッチしなかった場合も確認する。</p>
<pre lang="sql" class="highlight highlight-sql"><span class="n">MySQL</span> <span class="n">root</span><span class="o">@</span><span class="n">localhost</span><span class="p">:</span><span class="n">world</span><span class="o">&gt;</span> <span class="k">begin</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="k">rows</span> <span class="n">affected</span>
<span class="nb">Time</span><span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">003</span><span class="n">s</span>
<span class="n">MySQL</span> <span class="n">root</span><span class="o">@</span><span class="n">localhost</span><span class="p">:</span><span class="n">world</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">city</span> <span class="k">where</span> <span class="nv">`CountryCode`</span> <span class="o">=</span> <span class="s1">'NTY'</span> <span class="k">for</span> <span class="k">update</span>
<span class="o">+</span><span class="c1">----+------+-------------+----------+------------+</span>
<span class="o">|</span> <span class="n">ID</span> <span class="o">|</span> <span class="n">Name</span> <span class="o">|</span> <span class="n">CountryCode</span> <span class="o">|</span> <span class="n">District</span> <span class="o">|</span> <span class="n">Population</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">----+------+-------------+----------+------------+</span>
<span class="o">+</span><span class="c1">----+------+-------------+----------+------------+</span>

<span class="mi">0</span> <span class="k">rows</span> <span class="k">in</span> <span class="k">set</span>
<span class="nb">Time</span><span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">014</span><span class="n">s</span>
</pre>
<pre><code>------------
TRANSACTIONS
------------
Trx id counter 7010
Purge done for trx's n:o &lt; 7001 undo n:o &lt; 0 state: running but idle
History list length 0
LIST OF TRANSACTIONS FOR EACH SESSION:
---TRANSACTION 421497825593776, not started
0 lock struct(s), heap size 1128, 0 row lock(s)
---TRANSACTION 421497825592968, not started
0 lock struct(s), heap size 1128, 0 row lock(s)
---TRANSACTION 7009, ACTIVE 24 sec
2 lock struct(s), heap size 1128, 1 row lock(s)
MySQL thread id 99, OS thread handle 140022381811456, query id 705 172.21.0.1 root starting
show engine innodb status
TABLE LOCK table `world`.`city` trx id 7009 lock mode IX
RECORD LOCKS space id 2 page no 20 n bits 1272 index CountryCode of table `world`.`city` trx id 7009 lock_mode X locks gap before rec
Record lock, heap no 178 PHYSICAL RECORD: n_fields 2; compact format; info bits 0
 0: len 3; hex 4e5a4c; asc NZL;;
 1: len 4; hex 80000da6; asc     ;;
</code></pre>
<p><code>lock_mode X locks gap before rec</code>とあるので、ギャップロックが取得されている。この場合、<code>NTY</code>という<code>CountryCode</code>はなかったので、<code>NZL</code>という<code>CountryCode</code>の手前のギャップロックが取得されている。</p>
<p>マッチした場合とは異なり、セカンダリインデックスのみロックが取得され、クラスタリングインデックスには影響がなかった。</p>
<h1>インデックスなしでのロック</h1>
<p>最後にインデックスを使わない条件を指定して<code>select ... for update</code>してみる。</p>
<pre lang="sql" class="highlight highlight-sql"><span class="n">MySQL</span> <span class="p">(</span><span class="k">none</span><span class="p">)</span><span class="o">@</span><span class="p">(</span><span class="k">none</span><span class="p">):</span><span class="n">world</span><span class="o">&gt;</span> <span class="k">begin</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="k">rows</span> <span class="n">affected</span>
<span class="nb">Time</span><span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">001</span><span class="n">s</span>
<span class="n">MySQL</span> <span class="p">(</span><span class="k">none</span><span class="p">)</span><span class="o">@</span><span class="p">(</span><span class="k">none</span><span class="p">):</span><span class="n">world</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">city</span> <span class="k">where</span> <span class="nv">`Population`</span> <span class="k">between</span> <span class="mi">1000000</span> <span class="k">and</span> <span class="mi">1200000</span> <span class="k">for</span> <span class="k">update</span>
<span class="o">+</span><span class="c1">------+-------------------+-------------+----------------------+------------+</span>
<span class="o">|</span> <span class="n">ID</span>   <span class="o">|</span> <span class="n">Name</span>              <span class="o">|</span> <span class="n">CountryCode</span> <span class="o">|</span> <span class="n">District</span>             <span class="o">|</span> <span class="n">Population</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">------+-------------------+-------------+----------------------+------------+</span>
<span class="o">|</span> <span class="mi">71</span>   <span class="o">|</span> <span class="k">C</span><span class="err">ó</span><span class="n">rdoba</span>           <span class="o">|</span> <span class="n">ARG</span>         <span class="o">|</span> <span class="k">C</span><span class="err">ó</span><span class="n">rdoba</span>              <span class="o">|</span> <span class="mi">1157507</span>    <span class="o">|</span>
<span class="o">|</span> <span class="mi">133</span>  <span class="o">|</span> <span class="n">Perth</span>             <span class="o">|</span> <span class="n">AUS</span>         <span class="o">|</span> <span class="n">West</span> <span class="n">Australia</span>       <span class="o">|</span> <span class="mi">1096829</span>    <span class="o">|</span>
<span class="o">|</span> <span class="mi">216</span>  <span class="o">|</span> <span class="n">Bel</span><span class="err">é</span><span class="n">m</span>             <span class="o">|</span> <span class="n">BRA</span>         <span class="o">|</span> <span class="n">Par</span><span class="err">á</span>                 <span class="o">|</span> <span class="mi">1186926</span>    <span class="o">|</span>
<span class="o">|</span> <span class="mi">217</span>  <span class="o">|</span> <span class="n">Guarulhos</span>         <span class="o">|</span> <span class="n">BRA</span>         <span class="o">|</span> <span class="n">S</span><span class="err">ã</span><span class="n">o</span> <span class="n">Paulo</span>            <span class="o">|</span> <span class="mi">1095874</span>    <span class="o">|</span>
<span class="c1">--- (snip) ---</span>
</pre>
<p>同様にしてロックを確認する。</p>
<pre><code>------------
TRANSACTIONS
------------
Trx id counter 2671
Purge done for trx's n:o &lt; 2667 undo n:o &lt; 0 state: running but idle
History list length 0
LIST OF TRANSACTIONS FOR EACH SESSION:
---TRANSACTION 421394077937904, not started
0 lock struct(s), heap size 1136, 0 row lock(s)
---TRANSACTION 421394077936192, not started
0 lock struct(s), heap size 1136, 0 row lock(s)
---TRANSACTION 421394077935336, not started
0 lock struct(s), heap size 1136, 0 row lock(s)
---TRANSACTION 2670, ACTIVE 6 sec
25 lock struct(s), heap size 3520, 4103 row lock(s)
MySQL thread id 47, OS thread handle 139918963160832, query id 381 localhost root
TABLE LOCK table `world`.`city` trx id 2670 lock mode IX
RECORD LOCKS space id 2 page no 6 n bits 248 index PRIMARY of table `world`.`city` trx id 2670 lock_mode X
Record lock, heap no 1 PHYSICAL RECORD: n_fields 1; compact format; info bits 0
 0: len 8; hex 73757072656d756d; asc supremum;;

Record lock, heap no 2 PHYSICAL RECORD: n_fields 7; compact format; info bits 0
 0: len 4; hex 80000001; asc     ;;
 1: len 6; hex 00000000063a; asc      :;;
 2: len 7; hex 820000008a0110; asc        ;;
 3: len 30; hex 4b6162756c20202020202020202020202020202020202020202020202020; asc Kabul                         ; (total 35 bytes);
 4: len 3; hex 414647; asc AFG;;
 5: len 20; hex 4b61626f6c202020202020202020202020202020; asc Kabol               ;;
 6: len 4; hex 801b2920; asc   ) ;;

Record lock, heap no 3 PHYSICAL RECORD: n_fields 7; compact format; info bits 0
 0: len 4; hex 80000002; asc     ;;
 1: len 6; hex 00000000063a; asc      :;;
 2: len 7; hex 820000008a011d; asc        ;;
 3: len 30; hex 51616e646168617220202020202020202020202020202020202020202020; asc Qandahar                      ; (total 35 bytes);
 4: len 3; hex 414647; asc AFG;;
 5: len 20; hex 51616e6461686172202020202020202020202020; asc Qandahar            ;;
 6: len 4; hex 80039fbc; asc     ;;

Record lock, heap no 4 PHYSICAL RECORD: n_fields 7; compact format; info bits 0
 0: len 4; hex 80000003; asc     ;;
 1: len 6; hex 00000000063a; asc      :;;
 2: len 7; hex 820000008a012a; asc       *;;
 3: len 30; hex 486572617420202020202020202020202020202020202020202020202020; asc Herat                         ; (total 35 bytes);
 4: len 3; hex 414647; asc AFG;;
 5: len 20; hex 4865726174202020202020202020202020202020; asc Herat               ;;
 6: len 4; hex 8002d9b0; asc     ;;
--- (snip) ---
</code></pre>
<blockquote>
<p>RECORD LOCKS space id 2 page no 6 n bits 248 index PRIMARY of table <code>world</code>.<code>city</code> trx id 2670 lock_mode X</p>
</blockquote>
<p>とあるので、取得したクラスタインデックスすべてに対してネクストキーロックを取得していることがわかる。</p>
<h1>まとめ</h1>
<p>まとめると、こういうことがわかった。</p>
<ul>
<li>クラスタインデックスを使った<code>select ... for update</code>はマッチした行のレコードロックを取得する。マッチしなかった場合、条件の値を含む区間のギャップロックを取得する。</li>
<li>セカンダリインデックスを使った<code>select ... for update</code>はマッチしたセカンダリインデックスのネクストキーロックと次のレコードとの間のギャップロック、そしてマッチした行のレコードロックを取得する。マッチしなかった場合、セカンダリインデックスのみ条件の値を含む区間のギャップロックを取得する。</li>
<li>インデックスを使わない<code>select ... for update</code>はマッチした行のネクストキーロックを取得する。</li>
</ul>
<p>当たり前といえばそうなるけど、ロックを取得する場合でも可能な限りインデックスを利用してロックの範囲を狭めることが重要ということがわかった。</p>
<p>また、セカンダリインデックスを使った場合のロックの範囲は直感的には理解しにくいため、ハマりやすいポイントかもしれないが、今回いろいろ試してみることで理解が深まってよかった。</p>
        </section>
        <footer>
          <nav>
            <ul class="footer-links mb-0">
              <li class="footer-link"><a href="https://naoty.dev">Home</a></li>
              <li class="footer-link"><a href="/">Posts</a></li>
            </ul>
          </nav>
        </footer>
      </article>
    </main>
  </body>
</html>
