<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mrubyの初手</title>
    <link href="/normalize.css" rel="stylesheet">
    <link href="/main.css" rel="stylesheet">
    <link href="/favicon.png" rel="shortcut icon" type="image/png">
    <meta property="og:title" content="mrubyの初手">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://blog.naoty.dev/378/">
    <meta property="og:image" content="https://blog.naoty.dev/icon.png">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:creator" content="@naoty_k">
    <link href="/feed.xml" rel="alternate" type="application/atom+xml">
  </head>
  <body>
    <main>
      <article>
        <header>
          <h1 class="title mt-0">mrubyの初手</h1>
          <p class="metadata">
            <time datetime="2019-08-07T12:06:00.000+0900">2019-08-07 12:06</time>
            <a href="/mruby/">#mruby</a>
          </p>
        </header>
        <section class="body">
          <p>環境構築からmrubyを実行するCのコードをビルドするまで。</p>
<h1>環境構築</h1>
<pre lang="bash"><code>$ mkdir hello-mruby
$ cd hello-mruby
$ vi Dockerfile
</code></pre>
<pre lang="diff"><code>+FROM ruby:1.9
+RUN apt update &amp;&amp; \
+  apt install -y bison --no-install-recommends &amp;&amp; \
+  git clone https://github.com/mruby/mruby &amp;&amp; \
+  cd mruby &amp;&amp; \
+  ./minirake
+ENV PATH /mruby/bin:$PATH
+CMD [&quot;bash&quot;]
</code></pre>
<ul>
<li><a href="https://github.com/mruby/mruby/blob/master/doc/guides/compile.md#prerequisites">ドキュメント</a>を読むと、mrubyのビルドにはRuby 1.8か1.9、gcc、ar、bisonが必要とのことだった。<code>ruby:1.9</code>のイメージをベースにして、入ってなかったbisonだけインストールした。</li>
<li><code>./minirake</code>でmrubyがビルドされる。<code>bin/</code>以下にmrbcなどがあるので<code>PATH</code>に追加しておく。</li>
</ul>
<pre lang="bash"><code>$ docker build . -t naoty/hello-mruby
$ docker run -it --rm naoty/hello-mruby
% mirb
mirb - Embeddable Interactive Ruby Shell

&gt; MRUBY_VERSION
 =&gt; &quot;2.0.1&quot;
&gt; exit
% exit
</code></pre>
<ul>
<li>Dockerでmrubyをビルドできたことを確認した。</li>
</ul>
<h1>サンプルコードを追加する</h1>
<pre lang="bash"><code>$ vi Dockerfile
</code></pre>
<pre lang="diff"><code> FROM ruby:1.9
 RUN apt update &amp;&amp; \
   apt install -y bison --no-install-recommends &amp;&amp; \
   git clone https://github.com/mruby/mruby &amp;&amp; \
   cd mruby &amp;&amp; \
   ./minirake
 ENV PATH /mruby/bin:$PATH
+WORKDIR /hello-mruby
+COPY . /hello-mruby/
 CMD [&quot;bash&quot;]
</code></pre>
<ul>
<li>サンプルコードを用意していくので<code>WORKDIR</code>を用意する。</li>
</ul>
<pre lang="bash"><code>$ vi hello.rb
</code></pre>
<pre lang="diff"><code>+puts &quot;Hello, mruby!&quot;
</code></pre>
<pre lang="bash"><code>$ docker build . -t naoty/hello-mruby
</code></pre>
<ul>
<li>サンプルコードを追加してDockerイメージに追加する。</li>
</ul>
<pre lang="bash"><code>$ docker run -it --rm -v $(pwd):/hello-mruby naoty/hello-mruby
% mrbc hello.rb
% exit
</code></pre>
<ul>
<li>カレントディレクトリをマウントしてイメージを起動する。</li>
<li>mrbcで<code>hello.rb</code>から<code>hello.mrb</code>を生成する。マウントしているので、ホストにも<code>hello.mrb</code>が追加されている。</li>
</ul>
<h1>Cからmrubyを実行する</h1>
<pre lang="bash"><code>$ vi hello.c
</code></pre>
<pre lang="diff"><code>+#include 
+#include 
+#include 
+
+int main() {
+  mrb_state *mrb = mrb_open();
+
+  FILE *fd = fopen(&quot;hello.mrb&quot;, &quot;r&quot;);
+  mrb_load_irep_file(mrb, fd);
+
+  mrb_close(mrb);
+
+  return 0;
+}
</code></pre>
<ul>
<li>生成した<code>hello.mrb</code>を実行するCのコードを書く。</li>
<li>Cのコードは雰囲気で書いてるけど、<code>mrb_open</code>と<code>mrb_close</code>はお約束みたいで、<code>mrb_load_irep_file</code>によってmrbファイルを<code>load</code>するっぽい。</li>
</ul>
<pre lang="bash"><code>$ docker run -it --rm -v $(pwd):/hello-mruby naoty/hello-mruby
% gcc hello.c -I/mruby/include -L/mruby/build/host/lib -lmruby -lm -o hello
% ./hello
Hello, mruby!
</code></pre>
<ul>
<li>書いたCのコードをビルドするため、もう一度Dockerイメージを起動する。</li>
<li><code>hello.c</code>を<code>gcc</code>でビルドするには、まずヘッダーファイル<code>mruby.h</code>のパスを指定する必要がある。mrubyのヘッダーファイルは<code>/mruby/include/</code>以下にあるので、<code>-I</code>オプションで指定している。</li>
<li>次に、mruby本体のソースコードとともに<code>hello.c</code>をビルドする必要がある。mrubyのライブラリは<code>/mruby/build/host/lib/libmruby.a</code>なので、<code>-L</code>オプションにパスを指定し、<code>-l</code>オプションで<code>mruby</code>を指定している。</li>
<li>また、ビルドすると<code>/mruby/src/numeric.c:321: undefined reference to 'round'</code>のようなエラーが出てしまう。Mathのライブラリが足りなさそうなので、<code>-lm</code>オプションをつけて<code>libm.so</code>をリンクしている。</li>
<li>無事にビルドできた実行可能ファイルを実行してみると、<code>hello.rb</code>で書いたコードが実行された。</li>
</ul>
<hr />
<h1>追記</h1>
<p>Rubyは最新で問題ないです！問題があれば直すべきなので1.9はやめましょう… / 1件のコメント <a href="https://t.co/uu6C7Y3g0k">https://t.co/uu6C7Y3g0k</a> “mrubyの初手” (1 user) <a href="https://t.co/2bFP5uPQAu%E2%80%94">https://t.co/2bFP5uPQAu—</a> Uchio KONDO 🔫 (@udzura) August 7, 2019</p>
<p>ドキュメント(docs/guides/compile.md) を「2.0 or later」にアップデートします— Yukihiro Matsumoto (@yukihiro_matz) August 7, 2019</p>
<p>とのことなので、ベースイメージを<code>ruby:2.6</code>にしてみたけど問題なく上記の手順ができた。</p>
        </section>
        <footer>
          <nav>
            <ul class="footer-links mb-0">
              <li><a href="/">Posts</a></li>
            </ul>
          </nav>
        </footer>
      </article>
    </main>
  </body>
</html>
