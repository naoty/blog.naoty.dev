<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mrubyã®åˆæ‰‹</title>
    <link href="/normalize.css" rel="stylesheet">
    <link href="/main.css" rel="stylesheet">
    <link href="/highlight.css" rel="stylesheet">
    <link href="/favicon.png" rel="shortcut icon" type="image/png">
    <meta property="og:title" content="mrubyã®åˆæ‰‹">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://blog.naoty.dev/378/">
    <meta property="og:image" content="https://blog.naoty.dev/icon.png">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:creator" content="@naoty_k">
    <link href="/feed.xml" rel="alternate" type="application/atom+xml">
  </head>
  <body>
    <main>
      <article>
        <header>
          <h1 class="title mt-0">mrubyã®åˆæ‰‹</h1>
          <p class="metadata">
            <time datetime="2019-08-07T12:06:00.000+0900">2019-08-07 12:06</time>
            <a href="/mruby/">#mruby</a>
          </p>
        </header>
        <section class="body">
          <p>ç’°å¢ƒæ§‹ç¯‰ã‹ã‚‰mrubyã‚’å®Ÿè¡Œã™ã‚‹Cã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã¾ã§ã€‚</p>
<h1>ç’°å¢ƒæ§‹ç¯‰</h1>
<pre lang="bash" class="highlight highlight-bash"><span class="nv">$ </span><span class="nb">mkdir </span>hello-mruby
<span class="nv">$ </span><span class="nb">cd </span>hello-mruby
<span class="nv">$ </span>vi Dockerfile
</pre>
<pre lang="diff" class="highlight highlight-diff"><span class="gi">+FROM ruby:1.9
+RUN apt update &amp;&amp; \
+  apt install -y bison --no-install-recommends &amp;&amp; \
+  git clone https://github.com/mruby/mruby &amp;&amp; \
+  cd mruby &amp;&amp; \
+  ./minirake
+ENV PATH /mruby/bin:$PATH
+CMD ["bash"]
</span></pre>
<ul>
<li>
<a href="https://github.com/mruby/mruby/blob/master/doc/guides/compile.md#prerequisites">ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ</a>ã‚’èª­ã‚€ã¨ã€mrubyã®ãƒ“ãƒ«ãƒ‰ã«ã¯Ruby 1.8ã‹1.9ã€gccã€arã€bisonãŒå¿…è¦ã¨ã®ã“ã¨ã ã£ãŸã€‚<code>ruby:1.9</code>ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ™ãƒ¼ã‚¹ã«ã—ã¦ã€å…¥ã£ã¦ãªã‹ã£ãŸbisonã ã‘ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã€‚</li>
<li>
<code>./minirake</code>ã§mrubyãŒãƒ“ãƒ«ãƒ‰ã•ã‚Œã‚‹ã€‚<code>bin/</code>ä»¥ä¸‹ã«mrbcãªã©ãŒã‚ã‚‹ã®ã§<code>PATH</code>ã«è¿½åŠ ã—ã¦ãŠãã€‚</li>
</ul>
<pre lang="bash" class="highlight highlight-bash"><span class="nv">$ </span>docker build <span class="nb">.</span> <span class="nt">-t</span> naoty/hello-mruby
<span class="nv">$ </span>docker run <span class="nt">-it</span> <span class="nt">--rm</span> naoty/hello-mruby
% mirb
mirb - Embeddable Interactive Ruby Shell

<span class="o">&gt;</span> MRUBY_VERSION
 <span class="o">=&gt;</span> <span class="s2">"2.0.1"</span>
<span class="o">&gt;</span> <span class="nb">exit</span>
% <span class="nb">exit</span>
</pre>
<ul>
<li>Dockerã§mrubyã‚’ãƒ“ãƒ«ãƒ‰ã§ããŸã“ã¨ã‚’ç¢ºèªã—ãŸã€‚</li>
</ul>
<h1>ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã™ã‚‹</h1>
<pre lang="bash" class="highlight highlight-bash"><span class="nv">$ </span>vi Dockerfile
</pre>
<pre lang="diff" class="highlight highlight-diff"> FROM ruby:1.9
 RUN apt update &amp;&amp; \
   apt install -y bison --no-install-recommends &amp;&amp; \
   git clone https://github.com/mruby/mruby &amp;&amp; \
   cd mruby &amp;&amp; \
   ./minirake
 ENV PATH /mruby/bin:$PATH
<span class="gi">+WORKDIR /hello-mruby
+COPY . /hello-mruby/
</span> CMD ["bash"]
</pre>
<ul>
<li>ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’ç”¨æ„ã—ã¦ã„ãã®ã§<code>WORKDIR</code>ã‚’ç”¨æ„ã™ã‚‹ã€‚</li>
</ul>
<pre lang="bash" class="highlight highlight-bash"><span class="nv">$ </span>vi hello.rb
</pre>
<pre lang="diff" class="highlight highlight-diff"><span class="gi">+puts "Hello, mruby!"
</span></pre>
<pre lang="bash" class="highlight highlight-bash"><span class="nv">$ </span>docker build <span class="nb">.</span> <span class="nt">-t</span> naoty/hello-mruby
</pre>
<ul>
<li>ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¦Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã«è¿½åŠ ã™ã‚‹ã€‚</li>
</ul>
<pre lang="bash" class="highlight highlight-bash"><span class="nv">$ </span>docker run <span class="nt">-it</span> <span class="nt">--rm</span> <span class="nt">-v</span> <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>:/hello-mruby naoty/hello-mruby
% mrbc hello.rb
% <span class="nb">exit</span>
</pre>
<ul>
<li>ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ãƒã‚¦ãƒ³ãƒˆã—ã¦ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’èµ·å‹•ã™ã‚‹ã€‚</li>
<li>mrbcã§<code>hello.rb</code>ã‹ã‚‰<code>hello.mrb</code>ã‚’ç”Ÿæˆã™ã‚‹ã€‚ãƒã‚¦ãƒ³ãƒˆã—ã¦ã„ã‚‹ã®ã§ã€ãƒ›ã‚¹ãƒˆã«ã‚‚<code>hello.mrb</code>ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã€‚</li>
</ul>
<h1>Cã‹ã‚‰mrubyã‚’å®Ÿè¡Œã™ã‚‹</h1>
<pre lang="bash" class="highlight highlight-bash"><span class="nv">$ </span>vi hello.c
</pre>
<pre lang="diff" class="highlight highlight-diff"><span class="gi">+#include 
+#include 
+#include 
+
+int main() {
+  mrb_state *mrb = mrb_open();
+
+  FILE *fd = fopen("hello.mrb", "r");
+  mrb_load_irep_file(mrb, fd);
+
+  mrb_close(mrb);
+
+  return 0;
+}
</span></pre>
<ul>
<li>ç”Ÿæˆã—ãŸ<code>hello.mrb</code>ã‚’å®Ÿè¡Œã™ã‚‹Cã®ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã€‚</li>
<li>Cã®ã‚³ãƒ¼ãƒ‰ã¯é›°å›²æ°—ã§æ›¸ã„ã¦ã‚‹ã‘ã©ã€<code>mrb_open</code>ã¨<code>mrb_close</code>ã¯ãŠç´„æŸã¿ãŸã„ã§ã€<code>mrb_load_irep_file</code>ã«ã‚ˆã£ã¦mrbãƒ•ã‚¡ã‚¤ãƒ«ã‚’<code>load</code>ã™ã‚‹ã£ã½ã„ã€‚</li>
</ul>
<pre lang="bash" class="highlight highlight-bash"><span class="nv">$ </span>docker run <span class="nt">-it</span> <span class="nt">--rm</span> <span class="nt">-v</span> <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>:/hello-mruby naoty/hello-mruby
% gcc hello.c <span class="nt">-I</span>/mruby/include <span class="nt">-L</span>/mruby/build/host/lib <span class="nt">-lmruby</span> <span class="nt">-lm</span> <span class="nt">-o</span> hello
% ./hello
Hello, mruby!
</pre>
<ul>
<li>æ›¸ã„ãŸCã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹ãŸã‚ã€ã‚‚ã†ä¸€åº¦Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’èµ·å‹•ã™ã‚‹ã€‚</li>
<li>
<code>hello.c</code>ã‚’<code>gcc</code>ã§ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã«ã¯ã€ã¾ãšãƒ˜ãƒƒãƒ€ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«<code>mruby.h</code>ã®ãƒ‘ã‚¹ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚mrubyã®ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã¯<code>/mruby/include/</code>ä»¥ä¸‹ã«ã‚ã‚‹ã®ã§ã€<code>-I</code>ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§æŒ‡å®šã—ã¦ã„ã‚‹ã€‚</li>
<li>æ¬¡ã«ã€mrubyæœ¬ä½“ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¨ã¨ã‚‚ã«<code>hello.c</code>ã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚mrubyã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯<code>/mruby/build/host/lib/libmruby.a</code>ãªã®ã§ã€<code>-L</code>ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«ãƒ‘ã‚¹ã‚’æŒ‡å®šã—ã€<code>-l</code>ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§<code>mruby</code>ã‚’æŒ‡å®šã—ã¦ã„ã‚‹ã€‚</li>
<li>ã¾ãŸã€ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã¨<code>/mruby/src/numeric.c:321: undefined reference to 'round'</code>ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã—ã¾ã†ã€‚Mathã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒè¶³ã‚Šãªã•ãã†ãªã®ã§ã€<code>-lm</code>ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã¤ã‘ã¦<code>libm.so</code>ã‚’ãƒªãƒ³ã‚¯ã—ã¦ã„ã‚‹ã€‚</li>
<li>ç„¡äº‹ã«ãƒ“ãƒ«ãƒ‰ã§ããŸå®Ÿè¡Œå¯èƒ½ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Ÿè¡Œã—ã¦ã¿ã‚‹ã¨ã€<code>hello.rb</code>ã§æ›¸ã„ãŸã‚³ãƒ¼ãƒ‰ãŒå®Ÿè¡Œã•ã‚ŒãŸã€‚</li>
</ul>
<hr>
<h1>è¿½è¨˜</h1>
<p>Rubyã¯æœ€æ–°ã§å•é¡Œãªã„ã§ã™ï¼å•é¡ŒãŒã‚ã‚Œã°ç›´ã™ã¹ããªã®ã§1.9ã¯ã‚„ã‚ã¾ã—ã‚‡ã†â€¦ / 1ä»¶ã®ã‚³ãƒ¡ãƒ³ãƒˆ <a href="https://t.co/uu6C7Y3g0k">https://t.co/uu6C7Y3g0k</a> â€œmrubyã®åˆæ‰‹â€ (1 user) <a href="https://t.co/2bFP5uPQAu%E2%80%94">https://t.co/2bFP5uPQAuâ€”</a> Uchio KONDO ğŸ”« (@udzura) August 7, 2019</p>
<p>ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ(docs/guides/compile.md) ã‚’ã€Œ2.0 or laterã€ã«ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã—ã¾ã™â€” Yukihiro Matsumoto (@yukihiro_matz) August 7, 2019</p>
<p>ã¨ã®ã“ã¨ãªã®ã§ã€ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’<code>ruby:2.6</code>ã«ã—ã¦ã¿ãŸã‘ã©å•é¡Œãªãä¸Šè¨˜ã®æ‰‹é †ãŒã§ããŸã€‚</p>
        </section>
        <footer>
          <nav>
            <ul class="footer-links mb-0">
              <li><a href="/">Posts</a></li>
            </ul>
          </nav>
        </footer>
      </article>
    </main>
  </body>
</html>
