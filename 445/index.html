<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>予約システムを作ってロックについて学ぶ</title>
    <meta property="og:title" content="予約システムを作ってロックについて学ぶ">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://blog.naoty.dev/445/">
    <meta property="og:image" content="https://blog.naoty.dev/icon-512.png">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:creator" content="@naoty_k">
    <meta name="theme-color" content="#fff">
    <link href="/feed.xml" rel="alternate" type="application/atom+xml">
    <link href="/normalize.css" rel="stylesheet">
    <link href="/main.css" rel="stylesheet">
    <link href="/highlight.css" rel="stylesheet">
    <link href="/favicon.png" rel="shortcut icon" type="image/png">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192.png">
  </head>
  <body>
    <main>
      <article>
        <header>
          <h1 class="title mt-0">予約システムを作ってロックについて学ぶ</h1>
          <p class="metadata">
            <time datetime="2021-06-05T16:31:00.000+0000">2021-06-05 16:31</time>
            <a href="/mysql/">#mysql</a>
          </p>
        </header>
        <section class="body">
          <p>昨今話題となっている予約システムをもし自分が作るとしたらどのように作るか、興味が湧いてきた。</p>
<p>そこで、毎日10席までしか予約できないシステムを考えてみる。</p>
<p>予約を表すテーブルを定義する。</p>
<pre lang="sql" class="highlight highlight-sql"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">bookings</span> <span class="p">(</span>
  <span class="nv">`id`</span> <span class="nb">INT</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
  <span class="nv">`date`</span> <span class="nb">DATE</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">`customer_id`</span> <span class="nb">INT</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="nv">`id`</span><span class="p">),</span>
  <span class="k">UNIQUE</span> <span class="k">KEY</span> <span class="p">(</span><span class="nv">`date`</span><span class="p">,</span> <span class="nv">`customer_id`</span><span class="p">)</span>
<span class="p">);</span>
</pre>
<h1>ナイーブな実装</h1>
<p>100人の客が予約システムに殺到した状況をナイーブな実装で再現する。</p>
<pre lang="ruby" class="highlight highlight-ruby"><span class="nb">require</span> <span class="s2">"mysql2"</span>

<span class="no">CUSTOMER_SIZE</span> <span class="o">=</span> <span class="mi">100</span>
<span class="no">CAPACITY_PER_DAY</span> <span class="o">=</span> <span class="mi">10</span>

<span class="n">threads</span> <span class="o">=</span> <span class="p">[]</span>

<span class="mi">1</span><span class="p">.</span><span class="nf">upto</span><span class="p">(</span><span class="no">CUSTOMER_SIZE</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
  <span class="n">threads</span> <span class="o">&lt;&lt;</span> <span class="no">Thread</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">customer_id</span><span class="o">|</span>
    <span class="n">client</span> <span class="o">=</span> <span class="no">Mysql2</span><span class="o">::</span><span class="no">Client</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span>
      <span class="ss">host: </span><span class="no">ENV</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="s2">"MYSQL_HOST"</span><span class="p">),</span>
      <span class="ss">username: </span><span class="no">ENV</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="s2">"MYSQL_USERNAME"</span><span class="p">),</span>
      <span class="ss">password: </span><span class="no">ENV</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="s2">"MYSQL_PASSWORD"</span><span class="p">),</span>
      <span class="ss">database: </span><span class="no">ENV</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="s2">"MYSQL_DATABASE"</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">date</span> <span class="o">=</span> <span class="no">Date</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">2021</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">customer_id</span> <span class="o">%</span> <span class="mi">7</span><span class="p">)</span>
    <span class="n">statement</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">prepare</span><span class="p">(</span><span class="s2">"SELECT COUNT(*) AS count FROM bookings WHERE date = ?"</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">statement</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="ss">symbolize_keys: </span><span class="kp">true</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">results</span><span class="p">.</span><span class="nf">first</span><span class="p">[</span><span class="ss">:count</span><span class="p">]</span>
    <span class="nb">exit</span> <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;=</span> <span class="no">CAPACITY_PER_DAY</span>

    <span class="n">statement</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">prepare</span><span class="p">(</span><span class="s2">"INSERT INTO bookings (date, customer_id) VALUES (?, ?)"</span><span class="p">)</span>
    <span class="n">statement</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">customer_id</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="s2">"successfully booked: (</span><span class="si">#{</span><span class="n">date</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">customer_id</span><span class="si">}</span><span class="s2">)"</span>
  <span class="k">rescue</span> <span class="no">Mysql2</span><span class="o">::</span><span class="no">Error</span> <span class="o">=&gt;</span> <span class="n">exception</span>
    <span class="nb">puts</span> <span class="n">exception</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">threads</span><span class="p">.</span><span class="nf">each</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:join</span><span class="p">)</span>
</pre>
<p>これを実行したところ、日の上限である10席を超えてオーバーブッキングしてしまった。</p>
<pre><code>mysql&gt; select date, count(*) from bookings group by date;
+------------+----------+
| date       | count(*) |
+------------+----------+
| 2021-06-01 |       14 |
| 2021-06-02 |       15 |
| 2021-06-03 |       15 |
| 2021-06-04 |       14 |
| 2021-06-05 |       14 |
| 2021-06-06 |       14 |
| 2021-06-07 |       14 |
+------------+----------+
7 rows in set (0.00 sec)
</code></pre>
<table>
<thead>
<tr>
<th>time</th>
<th>transaction1</th>
<th>transaction2</th>
<th>count</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>select count(*) from bookings</td>
<td></td>
<td>9</td>
</tr>
<tr>
<td>2</td>
<td></td>
<td>select count(*) from bookings</td>
<td>9</td>
</tr>
<tr>
<td>3</td>
<td>insert into bookings</td>
<td></td>
<td>10</td>
</tr>
<tr>
<td>4</td>
<td></td>
<td>insert into bookings</td>
<td>11</td>
</tr>
</tbody>
</table>
        </section>
        <footer>
          <nav>
            <ul class="footer-links mb-0">
              <li class="footer-link"><a href="https://naoty.dev">Home</a></li>
              <li class="footer-link"><a href="/">Posts</a></li>
            </ul>
          </nav>
        </footer>
      </article>
    </main>
  </body>
</html>
